---

- name: set the serviceuser fact
  set_fact:
    serviceuser: intropwntoolsservice

- name: update repositories cache and install dependencies
  apt:
    name: "{{ item }}"
  with_items:
    - xinetd
    - python-pip
    - python-dev
    - git
    - libssl-dev
    - libffi-dev
    - build-essential

- name: install pwntools
  pip:
    name: pwntools

- name: create service user
  user:
    name: "{{ serviceuser }}"
    shell: /bin/false
    home: "/service/{{ serviceuser }}"
    groups: "leveluser"

- name: put the contents of service into the service account home directory
  copy:
    src: "service/"
    dest: "/service/{{ serviceuser }}"
    owner: "root"
    group: "{{ serviceuser }}"

- name: set the directory permissions
  block:
    - name: tighten the permissions
      file:
        recurse: yes
        mode: 440
        path: "/service/{{ serviceuser }}"
    - name: relax the permissions
      file:
        recurse: yes
        owner: root
        group: "{{ serviceuser }}"
        path: "/service/{{ serviceuser }}"
        mode: u=rwX,g=rX,o=

- name: setup the xinetd configuration files
  copy:
    src: "service/{{ serviceuser }}"
    dest: "/etc/xinetd.d/"

- name: make the python script executable
  file:
    path: "/service/{{ serviceuser }}/server.py"
    mode: 0450

- name: restart xinetd
  service:
    name: xinetd
    state: restarted

- name: put the contents of distrib into the home directory
  copy:
    src: "distrib/"
    dest: "{{ homedir }}/"
    owner: "root"
    group: "{{ level }}"
    mode: 0440
